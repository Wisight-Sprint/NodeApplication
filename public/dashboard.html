<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/dashboard.css">
    <link rel="stylesheet" href="./css/nav.css">
    <link rel="shortcut icon" href="./Assets/logo-sem-fundo.png" type="image/x-icon">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.11.0/dist/sweetalert2.all.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.11.0/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Dashboard | Wisight</title>

</head>

<body>
    <input type="text" name="" id="inpTeste">
    <button onclick="acharLocal()">aaa</button>
    <div class="containerNav">
        <div class="navLeft">
            <div class="container-logo"><img class="icon-logo" src="./Assets/logo-sem-fundo.png"></div>
            <div class="container-icon" id="telaAtual"> <img class="icon-graphic" src="./Assets/grafico.png"></div>
            <a href="suporte.html">
                <div class="container-icon"> <img class="icon-support" src="./Assets/apoio-suporte 1.png"></div>
            </a>
            <a href="gerenciamento.html">
                <div class="container-icon"><i class="fa-solid fa-user-gear"></i></div>
            </a>
            <a href="map.html">
                <div class="container-icon">
                    <i class="fa-solid fa-map-location-dot"></i>
                </div>
            </a>
            <div onclick="limparSessao()" class="container-icon"> <img class="icon-logout" src="./Assets/logout 2.png">
            </div></a>
        </div>
    </div>

    <div class="all-indicators">
        <div class="inline-row">
            <div class="title-page">Vítimas Por<br>região</div>
            <span class="city">Washington DC </span> <img class="icon-location" src="./Assets/location-icon.png">
        </div>

        <div class="welcome">Bem-vindo,&nbsp;<span id="bem_vindo" style="color: gray;"></span></div>

        <div class="chartsContainer">
            <div class="charts1Container">
                <div class="kpiContainer">
                    <div class="kpi">
                        <h1 id="h1AgesIncident">XX</h1>
                        <span id="h1AgesIncidents">Idade com mais <br> incidentes <br> <br>
                            <p id="pAgesIncident">Representando XX% do total de Mortes</p>
                        </span>
                    </div>

                    <div class="kpi">
                        <h1 id="h1BodyCam" style="color: orange;">XX%</h1>
                        <span id="h1BodyCamera">Taxa de oficiais com <br> câmera corporal<br><br>A porcentagem ideal
                            seria entre 80% e 90%</span>


                    </div>

                    <div class="kpi">
                        <h1 id="h1MentalDisorder" style="color: red;">XX%</h1>
                        <span id="h1MentalDisorders">Taxa de vítimas com <br> transtornos mentais</span>
                    </div>
                    <div class="kpi">
                        <h1 id="h1Gende">XXX</h1>
                        <span id="h1Gender">Gênero de vítimas com <br><br>
                            <p id="pGender">Representando mais de XX% dos incidentes</p>
                        </span>
                    </div>
                </div>

                <div class="chart1">
                    <div class="armed-victims">
                        <h2>Vítimas Armadas</h2>
                        <div class="graphicSize1"><canvas id="PieChart" style="opacity: 1;"></canvas></div>
                    </div>

                    <div class="line-vertical"></div>

                    <div class="ethnicity-victims">
                        <h2>Etnia da Vítima</h2>
                        <div class="graphicSize2"><canvas id="PieChart2" style="opacity: 1;"></canvas></div>
                    </div>

                    <div class="line-vertical"></div>

                    <div class="escape-victims">
                        <h2>Tentativas de fuga</h2>
                        <div class="graphicSize3"><canvas id="PieChart3" style="opacity: 1;"></canvas></div>
                    </div>
                </div>

            </div>

            <div class="charts2Container">
                <div class="chart2">
                    <h2 class="monthly-victims">Vítimas Mensais</h2>
                    <div id="BarChart" style="width: 95%; height: 400px;"></div>

                </div>
            </div>
        </div>
    </div>


</body>

</html>

<script>

    window.onload = validarSessao();

    const vitimas2023 = [120, 160, 120, 110];
    const vitimas2024 = [145, 140, 130, 140];

    const labels = ['Janeiro', 'Fevereiro', 'Março', 'Abril',];

    function getColor(value, year) {
        //if (value > 150) return 'rgb(255, 0, 0)'; 
        return year === 2023 ? 'rgb(255, 220, 0)' : 'rgb(0, 0, 255)';
    }

    function acharLocal() {
    var local = inpTeste.value;  

    if (tipoLocalizacao == "departamento") {

        fetch(`/departamento/buscarDepartamentoPorNome?departamentoServer=${local}`, {
            method: "GET",
        })
            .then(function (response) {
                return response.json();
            })
            .then(data => {
                console.log(data)

                for (let i = 0; i < departamentos.length; i++) {
                    const depDaVez = departamentos[i];
                    
                    if (local === depDaVez) { 
                        localizacaoUsuario = data[0]["departamento_id"];
                        break;  
                    }
                }
            })
            .catch(error => console.error(`Erro na obtenção de dados: ${error.message}`));


    } else if (tipoLocalizacao == "cidade") {
        for (let i = 0; i < cidades.length; i++) {
            const cidadeDaVez = cidades[i];

            if (local === cidadeDaVez) {  
                localizacaoUsuario = local;  
                break;  
            }
        }
        
    } else if (tipoLocalizacao == "estado") {
        for (let i = 0; i < estados.length; i++) {
            const estadoDaVez = estados[i];

            if (local === estadoDaVez) { 
                localizacaoUsuario = local;  
                break;  
            }
        }
        
    } else {
    // div que tem o pesquisar some ou algo parecido
        console.log("Tipo de localização inválido.");
    }    

    console.log(local)
    console.log(localizacaoUsuario)
    chamarGraficos()

}

    var estados = []
    var cidades = []
    var departamentos = []

    var localizacaoUsuario = sessionStorage.DEPARTAMENTO_USUARIO
    var tipoLocalizacao = "departamento"

    function visualizarDepartamento() {
        tipoLocalizacao = "departamento"
        localizacaoUsuario = sessionStorage.DEPARTAMENTO_USUARIO
        chamarGraficos()
    }

    function visualizarCidades() {
        tipoLocalizacao = "cidade"
        localizacaoUsuario = sessionStorage.CIDADE_USUARIO
        chamarGraficos()
    }

    function visualizarEstado() {
        tipoLocalizacao = "estado"
        localizacaoUsuario = sessionStorage.ESTADO_USUARIO
        chamarGraficos()
    }

    function exibirGeral() {
        localizacaoUsuario = ""
        tipoLocalizacao = ""
        chamarGraficos()
    }

    function exibirMeuLocal() {
        localizacaoUsuario = sessionStorage.DEPARTAMENTO_USUARIO
        tipoLocalizacao = "departamento"
        chamarGraficos()
    }

    function obterRegioes() {
        fetch(`/dashboard/obterRegioes`, {
            method: "GET",
        })
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                console.table(JSON.stringify(data));

                data.forEach(item => {
                    estados.push(`${item.estado}`)
                    cidades.push(`${item.cidade}`)
                    departamentos.push(`${item.nome}`)
                })

                console.log(estados)
                console.log(cidades)
                console.log(departamentos)

            })
            .catch(error => console.error(`Erro na obtenção de dados: ${error.message}`));
    }

    function chamarGraficos() {
        obterArma()
        obterCameraCorporal()
        obterEtnia()
        obterFuga()
        obterGenero()
        obterMediaIdade()
        obterRegioes()
        obterTranstorno()
        obterVitima()
    }

    function obterMediaIdade() {
        fetch(`/dashboard/obterMediaIdade?cidadeServerUsuario=${localizacaoUsuario}&tipoLocalizacaoServer=${tipoLocalizacao}`, { cache: 'no-store' })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro na requisição: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                var h1Element = document.getElementById('h1AgesIncident')
                var pElement = document.getElementById('pAgesIncident')
                var idadeMedia = Number(data[0]["idadeIncidente"])
                var pctMortes = Number(data[0]["porcentagem"])
                idadeMedia = Number(idadeMedia.toFixed(0))
                pctMortes = pctMortes.toFixed(2)
                h1Element.innerText = idadeMedia
                pElement.innerText = `Representando ${pctMortes}% do total de Mortes`
            })
            .catch(error => console.error(`Erro na obtenção de dados: ${error.message}`));
    }

    function obterCameraCorporal() {
        fetch(`/dashboard/obterCameraCorporal?cidadeServerUsuario=${localizacaoUsuario}&tipoLocalizacaoServer=${tipoLocalizacao}`, { cache: 'no-store' })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro na requisição: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                var h1Camera = document.getElementById('h1BodyCam')
                var pctCamera = Number(data[0]["porcentagem"])
                pctCamera = pctCamera.toFixed(2)
                h1Camera.innerText = `${pctCamera}%`
            })
            .catch(error => console.error(`Erro na obtenção de dados: ${error.message}`));
    }

    function obterTranstorno() {
        fetch(`/dashboard/obterTranstorno?cidadeServerUsuario=${localizacaoUsuario}&tipoLocalizacaoServer=${tipoLocalizacao}`, { cache: 'no-store' })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro na requisição: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                var h1Mental = document.getElementById('h1MentalDisorder')
                var pctMental = Number(data[0]["porcentagem"])
                pctMental = pctMental.toFixed(2)
                h1Mental.innerText = `${pctMental}%`
            })
            .catch(error => console.error(`Erro na obtenção de dados: ${error.message}`));
    }

    function obterGenero() {
        fetch(`/dashboard/obterGenero?cidadeServerUsuario=${localizacaoUsuario}&tipoLocalizacaoServer=${tipoLocalizacao}`, { cache: 'no-store' })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro na requisição: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                var h1Element = document.getElementById('h1Gende')
                var pElement = document.getElementById('pGender')
                var genero = data[0]["generoIncidente"]
                var pctMortes = Number(data[0]["porcentagem"])
                pctMortes = pctMortes.toFixed(2)
                h1Element.innerText = genero
                pElement.innerText = `Representando ${pctMortes}% dos incidentes`
            })
            .catch(error => console.error(`Erro na obtenção de dados: ${error.message}`));

    }

    function obterVitima() {
        fetch(`/dashboard/obterVitima?cidadeServerUsuario=${localizacaoUsuario}&tipoLocalizacaoServer=${tipoLocalizacao}`, { cache: 'no-store' })
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                let meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                let vitimas2023 = new Array(12).fill(0);
                let vitimas2024 = new Array(12).fill(0);

                data.forEach(function (item) {
                    if (item.ano === 2023) {
                        vitimas2023[item.mes - 1] = item.total_vitimas;
                    } else if (item.ano === 2024) {
                        vitimas2024[item.mes - 1] = item.total_vitimas;
                    }
                });

                Highcharts.chart('BarChart', {
                    chart: {
                        type: 'bar'
                    },
                    title: {
                        text: 'Vítimas por Mês - Comparação entre 2023 e 2024',
                        style: {
                            fontSize: '22px',
                            fontWeight: 'bold'
                        }
                    },
                    xAxis: {
                        categories: meses,
                        title: {
                            text: 'Mês'
                        },
                        labels: {
                            formatter: function () {
                                return this.value;
                            }
                        }
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'Número de Vítimas'
                        },
                        labels: {
                            formatter: function () {
                                return this.value;
                            }
                        }
                    },
                    series: [{
                        name: 'Vítimas em 2023',
                        color: 'rgb(255, 220, 0)',
                        data: vitimas2023
                    }, {
                        name: 'Vítimas em 2024',
                        color: 'rgb(0, 0, 255)',
                        data: vitimas2024
                    }],
                    plotOptions: {
                        series: {
                            pointPadding: 0.1,
                            groupPadding: 0.1,
                            dataLabels: {
                                enabled: true
                            }
                        }
                    }
                });
            })
            .catch(function (error) {
                console.log("Ocorreu um erro:", error);
            });
    }



    function obterArma() {
        fetch(`/dashboard/obterArma?cidadeServerUsuario=${localizacaoUsuario}&tipoLocalizacaoServer=${tipoLocalizacao}`, { cache: 'no-store' })
            .then(function (response) {
                return response.json()
            })
            .then(function (data) {
                console.log(data)

                let armamentos = {
                    'Não armado': 0,
                    'Arma de fogo': 0,
                    'Arma Branca': 0
                };

                data.forEach(function (item) {
                    if (armamentos[item.armamento] !== undefined) {
                        armamentos[item.armamento] = item.quantidade;
                    }
                });

                // depois trocar esse mychart por:
                // myChart.data.datasets[0].data = [
                //     armamentos['Gun'], 
                //     armamentos['unarmed'], 
                //     armamentos['knife']
                // ];

                myChart.data.datasets[0].data = [
                    armamentos['Não armado'],
                    armamentos['Arma de fogo'],
                    armamentos['Arma branca']
                ];

                myChart.update();
            })
            .catch(function (error) {
                console.log("Ocorreu um erro:", error);
            });
    }

    const ctx2 = document.getElementById('PieChart');

    const myChart = new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: ['Desarmado', 'Arma de fogo', 'Arma branca'],
            datasets: [{
                label: 'Distribuição de armas',
                data: [0, 0, 0, 0, 0],
                backgroundColor: [
                    'rgba(128, 128, 128, 1)',
                    'rgba(110, 172, 218, 1)',
                    'rgba(44, 65, 89, 1)'
                ],
                borderColor: [
                    'rgba(128, 128, 128, 1)',
                    'rgba(110, 172, 218, 1)',
                    'rgba(44, 65, 89, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            weight: 'bold'
                        },
                        color: 'rgba(0,0,0)',
                        padding: 10
                    }
                }
            }
        }
    });


    function obterEtnia() {
        fetch(`/dashboard/obterEtnia?cidadeServerUsuario=${localizacaoUsuario}&tipoLocalizacaoServer=${tipoLocalizacao}`, { cache: 'no-store' })
            .then(function (response) {
                return response.json()
            })
            .then(function (data) {
                console.log(data)

                let etnias = {
                    'Hispânica': 0,
                    'Asiática': 0,
                    'Branca': 0,
                    'Negra': 0,
                    'Indígena': 0
                };

                data.forEach(function (item) {
                    if (etnias[item.etnia] !== undefined) {
                        etnias[item.etnia] = item.quantidade;
                    }
                });

                // depois trocar esse mychart por:
                // myChartEtnia.data.datasets[0].data = [
                //     etnias['Hispanic'], 
                //     etnias['Asian'], 
                //     etnias['White'],
                //     etnias['Black']
                // ];

                myChartEtnia.data.datasets[0].data = [
                    etnias['Hispânica'],
                    etnias['Asiática'],
                    etnias['Branca'],
                    etnias['Negra'],
                    etnias['Indígena']
                ];

                myChartEtnia.update();
            })
            .catch(function (error) {
                console.log("Ocorreu um erro:", error);
            });
    }


    const ctx3 = document.getElementById('PieChart2');

    const myChartEtnia = new Chart(ctx3, {
        type: 'pie',
        data: {
            labels: ['Etnia Hispânica', 'Etnia Asiática', 'Etnia Branca', 'Etnia Negra', 'Etnia Indígena'],
            datasets: [{
                label: 'Etnias',
                data: [0, 0, 0, 0, 0],
                backgroundColor: [
                    'rgb(74, 144, 226)',
                    'rgb(0, 0, 156)',
                    'rgb(128, 128, 128)',
                    'rgb(0, 0, 0)',
                    'rgb(255, 255, 255)'
                ],
                borderColor: [
                    'rgb(74, 144, 226)',
                    'rgb(0, 0, 156)',
                    'rgb(128, 128, 128)',
                    'rgb(0, 0, 0)',
                    'rgb(200, 200, 200)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            weight: 'bold'
                        },
                        color: 'rgba(0,0,0)',
                        padding: 10
                    }
                }
            }
        }
    });

    function obterFuga() {

        fetch(`/dashboard/obterFuga?cidadeServerUsuario=${localizacaoUsuario}&tipoLocalizacaoServer=${tipoLocalizacao}`, { cache: 'no-store' })
            .then(function (response) {
                return response.json()
            })
            .then(function (data) {
                console.log(data)

                let fugas = {
                    'A pé': 0,
                    'Veículo': 0,
                    'Sem tentativa': 0
                };

                data.forEach(function (item) {
                    if (fugas[item.fuga] !== undefined) {
                        fugas[item.fuga] = item.quantidade;
                    }
                });

                // depois trocar esse mychart por:
                // myChartEtnia.data.datasets[0].data = [
                //     etnias['Hispanic'], 
                //     etnias['Asian'], 
                //     etnias['White'],
                //     etnias['Black']
                // ];

                myChartFuga.data.datasets[0].data = [
                    fugas['A pé'],
                    fugas['Veículo'],
                    fugas['Sem tentativa']
                ];

                myChartFuga.update();
            })
            .catch(function (error) {
                console.log("Ocorreu um erro:", error);
            });

    }

    const ctx4 = document.getElementById('PieChart3');

    const myChartFuga = new Chart(ctx4, {
        type: 'pie',
        data: {
            labels: ['Com os pés', 'Veículo motorizado', 'Não houve tentativa'],
            datasets: [{
                label: 'Cores favoritas',
                data: [0, 0, 0],
                backgroundColor: [
                    'rgb(255, 0, 0)',
                    'rgb(255, 220, 0)',
                    'rgb(246, 120, 40)',
                ],
                borderColor: [
                    'rgb(255, 0, 0)',
                    'rgb(255, 220, 0)',
                    'rgb(246, 120, 40)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            weight: 'bold'
                        },
                        color: 'rgba(0,0,0)'
                    }
                }
            }
        }
    });

    chamarGraficos()

</script>