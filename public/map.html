<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Relatórios Policiais por Estado</title>
    <link rel="shortcut icon" href="./Assets/logo-sem-fundo.png" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.11.0/dist/sweetalert2.all.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.11.0/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="./css/map.css">
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&display=swap");
    </style>
</head>

<body>
    <a href="dashboard.html">
        <button class="btnOut">
            <span>
                <i class="fa-solid fa-xmark"></i>
            </span>
        </button>
    </a>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        Swal.fire({
            title: "Este é o mapa dinâmico!",
            text: "Aqui, você tem uma visão macro do seu país! Clicando no estado que deseja ver, você terá seu nome e algumas informações relevantes.",
            icon: "question",
            background: "#FFF",
            color: "#000",
            showConfirmButton: true,
            confirmButtonColor: "#3085d6",
            confirmButtonText: "Ok"
        });

        const map = L.map('map', {
            center: [37.8, -96],  // Centro aproximado dos EUA
            zoom: 4,  // Nível de zoom para abranger os EUA
            maxBounds: [[24.396308, -125.0], [49.384358, -66.93457]],  // Limites aproximados dos EUA
            maxBoundsViscosity: 1.0,  // Restringe totalmente a visão dentro dos EUA
            minZoom: 4,  // Define um mínimo de zoom para impedir a visão muito ampla
            maxZoom: 8,   // Define um máximo de zoom para evitar detalhes muito específicos

        });

        // Adicionar camada de mapa (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        L.control.scale({
            position: 'bottomleft',
            imperial: false,
            metric: true
        }).addTo(map);


        // Função para definir a cor do estado com base no total de relatórios
        function getColor(d) {
            return d > 14 ? 'red' :
                d > 10 ? 'orange' :
                    d > 8 ? 'yellow' :
                        d > 3 ? 'green' :
                            d > 1 ? 'blue' :
                                d === 0 ? 'transparent' : // ou outra cor para valores entre 0 e 1
                                    '#FFEDA0'; // ou cor padrão para 0
        }

        // Função para estilizar cada estado
        function style(feature) {
            const estado = feature.properties.name;
            const estadoData = estadosData[estado] || { total_relatorios: 0, porcentagemCamera: 0, porcentagemMental: 0 };
            const totalRelatorios = estadoData.total_relatorios;
            return {
                fillColor: getColor(totalRelatorios),
                weight: 1,
                opacity: 1,
                color: '#FFF',
                dashArray: '3',
                fillOpacity: 0.7,
            };
        }

        // Função para exibir popup com informações do estado
        function onEachFeature(feature, layer) {
            const estado = feature.properties.name;
            const estadoData = estadosData[estado] || { total_relatorios: 0, porcentagemCamera: 0, porcentagemMental: 0 };
            const totalRelatorios = estadoData.total_relatorios;
            const porcentagemCamera = estadoData.porcentagemCamera;
            const porcentagemMental = estadoData.porcentagemMental;

            // Adiciona um popup com os dados do estado
            layer.on('click', function () {
                layer.bindPopup(`<b>Estado:</b> ${estado}<br><b>Total de Relatórios:</b> ${totalRelatorios}<br><b>Utilização da Câmera Corporal:</b> ${porcentagemCamera}%<br><b>Casos com Problemas Mentais:</b> ${porcentagemMental}%`).openPopup();
            });
        }

        // Variável para armazenar dados de relatórios por estado
        let estadosData = {};

        // Carregar dados dos relatórios do backend
        async function carregarDados() {
            const response = await fetch("/apiMapa/criarMapa");
            const data = await response.json();

            // Transformar dados para um formato fácil de acessar
            data.forEach(item => {
                estadosData[item.estado] = {
                    total_relatorios: item.total_relatorios,
                    porcentagemCamera: item.porcentagemCamera,
                    porcentagemMental: item.porcentagemMental
                }
            });


            // Carregar GeoJSON dos estados e aplicar estilo
            fetch("https://raw.githubusercontent.com/Joao-Noce/geoJsonUSA/refs/heads/main/USA_With_States.geo.json")
                .then(response => response.json())
                .then(geojson => {
                    L.geoJson(geojson, {
                        style: style,
                        onEachFeature: onEachFeature // Adiciona função para cada estado
                    }).addTo(map);
                });
        }

        // Inicializar carregamento dos dados
        carregarDados();
    </script>
</body>

</html>