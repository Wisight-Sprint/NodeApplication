<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro Wisight</title>
    <link rel="stylesheet" href="./css/cadastro.css" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&display=swap");
    </style>
    <script src="./js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.11.0/dist/sweetalert2.all.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.11.0/dist/sweetalert2.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="container">
      <div class="voltar">
        <a href="./index.html">
          <div class="seta">
            <img
              src="./Assets/seta (2).png"
              alt=""
              style="width: 50px; height: 50px"
            />
          </div>
        </a>
      </div>

      <div class="textos">
        <h1>SEJA BEM VINDO!</h1>
        <div class="traco"></div>
        <p>
          É um prazer ter um novo usuário em nossa plataforma! Aproveite ao
          máximo nossos serviços, aqui você voa com dados!
        </p>
        <div class="imagem">
          <img id="imagem" src="./Assets/logo-sem-fundo.png" />
        </div>
      </div>

      <div class="campos">
        <div class="inp">
          <p>Insira o seu nome:</p>
          <input type="text" class="input" id="inpNome" />

          <p>Insira o nome do seu departamento</p>
          <input type="text" class="input" id="inpDep" />

          <p>Insira o número do seu distintivo</p>
          <input type="text" class="input" id="inpNumero" />

          <p>Insira um email para contato:</p>
          <input type="text" class="input" id="inpEmail" />

          <p class="inp_senha">Insira uma senha:</p>
          <div class="senhas">
            <input type="password" class="input" id="inpSenha" />
            <div id="botao_ocultar1" class="olho" onclick="ocultar1()">
              <img id="olho_ocultar1" src="./Assets/closed-eye.png" />
            </div>
          </div>

          <p class="inp_senha">Confirme sua senha:</p>
          <div class="senhas">
            <input type="password" class="input" id="inpConfSenha" />
            <div id="botao_ocultar2" class="olho" onclick="ocultar2()">
              <img id="olho_ocultar2" src="./Assets/closed-eye.png" />
            </div>
          </div>
        </div>
        <div class="possui">
          <p>Já possui conta? <a href="./login.html"> ‎Clique Aqui</a></p>
        </div>

        <button id="butao" onclick="cadastrarUsuario()">Cadastrar</button>
      </div>
    </div>
  </body>
</html>

<script>
  function ocultar1() {
    if (inpSenha.type == "password") {
      inpSenha.type = "text";
      botao_ocultar1.innerHTML =
        '<img id="img_ocultar" src="./Assets/eye_opened.png">';
    } else {
      inpSenha.type = "password";
      botao_ocultar1.innerHTML =
        '<img id="img_ocultar" src="./Assets/closed-eye.png">';
    }
  }
  function ocultar2() {
    if (inpConfSenha.type == "password") {
      inpConfSenha.type = "text";
      botao_ocultar2.innerHTML =
        '<img id="img_ocultar" src="./Assets/eye_opened.png">';
    } else {
      inpConfSenha.type = "password";
      botao_ocultar2.innerHTML =
        '<img id="img_ocultar" src="./Assets/closed-eye.png">';
    }
  }

  let departamentoId;

  async function cadastrarUsuario() {
    let nome = inpNome.value;
    let email = inpEmail.value;
    let senha = inpSenha.value;
    let confSenha = inpConfSenha.value;
    let departamento = inpDep.value;
    let numero = inpNumero.value;

    departamento = departamento.toLowerCase();

    const caracteresEspeciais = "#@!$%&";
    let temCaractereEspecial = false;

    console.log("ta aqui");

    for (let i = 0; i < caracteresEspeciais.length; i++) {
      if (senha.indexOf(caracteresEspeciais[i]) !== -1) {
        temCaractereEspecial = true;
        break;
        console.log("if do for");
      }
    }

    if (nome.length < 4) {
      inpNome.value = "";
      inpNome.placeholder = `Nome inválido.`;
      inpNome.style = `border: solid red 2px`;
    } else if (email.indexOf("@") == -1 || email.length < 8) {
      inpEmail.value = "";
      inpEmail.placeholder = `Email precisa conter @.`;
      inpEmail.style = `border: solid red 2px`;
    } else if (senha.length < 8) {
      inpSenha.value = "";
      inpSenha.placeholder = `Necessário no mínimo 8 caracteres.`;
      inpSenha.style = `border: solid red 2px`;
    } else if (!temCaractereEspecial) {
      console.log("if do caracter deu ruim");
      inpSenha.value = "";
      inpSenha.placeholder = `Necessário pelo menos um caractere especial.`;
      inpSenha.style = `border: solid red 2px`;
    } else if (confSenha != senha) {
      inpSenha.style = `border: solid red 2px`;
      inpConfSenha.value = "";
      inpConfSenha.placeholder = `As senhas precisam ser iguais.`;
      inpConfSenha.style = `border: solid red 2px`;
    } else if (departamento == "") {
      inpDep.placeholder = "Campo necessário para cadastro.";
      inpDep.style = `border: solid red 2px`;
    } else if (numero == "") {
      inpNumero.placeholder = "Campo necessário para cadastro.";
      inpNumero.style = `border: solid red 2px`;
    } else {
      inpDep.value = "";
      inpDep.placeholder = "";
      inpDep.style = `border: none;`;
      inpNumero.value = "";
      inpNumero.placeholder = "";
      inpNumero.style = `border: none;`;
      try {
        // Primeiro fetch para buscar o departamento
        const responseDepartamento = await fetch(
          "departamento/buscarDepartamentoPorNome",
          {
            method: "POST",
            headers: {
              "Content-type": "application/json",
            },
            body: JSON.stringify({
              departamentoServer: departamento,
            }),
          }
        );
        if (responseDepartamento.ok) {
          Swal.fire({
            position: "center",
            icon: "success",
            title: "Conta criada com sucesso",
            background: "#FFF",
            color: "#000",
            showConfirmButton: false,
            timer: 1500,
          });
          if (responseDepartamento.ok) {
            const jsonDepartamento = await responseDepartamento.json();
            departamentoId = jsonDepartamento.departamento_id;
            console.log("Departamento encontrado, ID:", departamentoId);
            // Segundo fetch para cadastrar o usuário
            const responseUsuario = await fetch("users/cadastrarUsuario", {
              method: "POST",
              headers: {
                "Content-type": "application/json",
              },
              body: JSON.stringify({
                nomeServer: nome,
                emailServer: email,
                senhaServer: senha,
                departamentoIdServer: departamentoId,
                numeroServer: numero,
              }),
            });
            if (responseUsuario.ok) {
              console.log("Cadastro realizado com sucesso!");
              setTimeout(() => {
                window.location = "login.html";
              }, 2000);
            } else {
              const errorText = await responseUsuario.text();
              throw new Error("Erro ao cadastrar usuário: " + errorText);
            }
          } else {
            const errorText = await responseDepartamento.text();
            throw new Error("Erro ao buscar departamento: " + errorText);
          }
        }
      } catch (error) {
        console.log("Erro:", error);
      }
    }
  }
</script>
