<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="./js/sessao.js"></script>
  <link rel="stylesheet" href="./css/insights.css" />
  <link rel="stylesheet" href="./css/nav.css" />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&display=swap");
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <title>Insights | Wisight</title>
</head>

<body>
  <h1>Enviar Departamento para o Servidor</h1>
  <button id="sendDepIdButton">Gerar insights</button>
  <div id="textAreaInsights"></div>
</body>

</html>

<script>
  document
    .getElementById("sendDepIdButton", async function () {
      const userPermission = sessionStorage.getItem("PERMISSAO_USUARIO");
      let userInsightKey;
      let bodyServerName;
      let whereParam;
      let joinParam;

      if (userPermission == "Governador") {
        userInsightKey = sessionStorage.getItem("ESTADO_USUARIO");
        bodyServerName = "userStateNameServer";
        whereParam = "fk_cidade_estado";
        joinParam = "JOIN cidade_estado c ON i.fk_cidade_estado = c.cidade_estado_id";
        await sendValueForJava(userInsightKey, stringFetch, bodyServerName);
        await getInsights(userInsightKey, whereParam, joinParam);
      } else {
        userInsightKey = sessionStorage.getItem("DEPARTAMENTO_USUARIO");
        bodyServerName = "depUserServer";
        whereParam = "fk_departamento";
        joinParam = "JOIN departamento d on i.fk_departamento = d.departamento_id";
        await sendValueForJava(userInsightKey, bodyServerName);
        await getInsights(userInsightKey, whereParam, joinParam);
      }
    });

  async function sendValueForJava(userInsightKey, bodyServerName) {
    let obj = {};
    obj[bodyServerName] = userInsightKey;

    if (userInsightKey && obj) {
      await fetch("/insight/executeJar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(obj)
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            console.log("Arquivo .jar executado com sucesso.");
          } else {
            console.log("Erro ao executar .jar: ", data.message);
          }
        })
        .catch((error) => {
          console.error("Erro na requisição:", error);
        });
    } else {
      console.log(
        "Valor não encontrado no sessionStorage."
      );
    }
  }

  var teste;

  async function getInsight(userInsightKey, whereParam, joinParam) {
    if (userInsightKey && whereParam && joinParam) {
      await fetch("/insight/getInsight", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          userInsightKeyServer: userInsightKey,
          whereParamServer: whereParam,
          joinParamServer: joinParam
        }),
      })
        .then(res => {
          if (res.ok) {
            res.json().then(json => {
              document.getElementById("textAreaInsights").innerHTML = `${json.texto_insight}`
            });
          } else {
            res.text().then(texto => {
              throw "Houve um erro ao autenticar" + texto;
            });
          }
          console.log("Response .then autenticar: " + res);
        })
        .catch((error) => {
          console.error("Erro na requisição:", error);
        });
    } else {
      console.log(
        "Valor não encontrado no sessionStorage."
      );
    }

  }

</script>