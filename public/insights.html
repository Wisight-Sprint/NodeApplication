<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="./js/sessao.js"></script>
  <link rel="stylesheet" href="./css/insights.css" />
  <link rel="stylesheet" href="./css/nav.css">
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&display=swap");
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <title>Insights | Wisight</title>
</head>

<body>
  <div class="principalContainer">

    <div class="containerNav">
      <div class="navLeft">
        <div class="container-logo"><img class="icon-logo" src="./Assets/logo-sem-fundo.png"></div>
        <a href="dashboard.html">
          <div class="container-icon"> <img class="icon-graphic" src="./Assets/grafico.png"></div>
        </a>
        <a href="suporte.html">
          <div class="container-icon"> <img class="icon-support" src="./Assets/apoio-suporte 1.png"></div>
        </a>
        <a href="gerenciamento.html">
          <div class="container-icon"><i class="fa-solid fa-user-gear"></i></div>
        </a>
        <a href="map.html">
          <div class="container-icon">
            <i class="fa-solid fa-map-location-dot"></i>
          </div>
        </a>
        <div class="container-icon" id="telaAtual"> <img class="icon-insights" src="./Assets/Insights.png"></div>
        <div onclick="limparSessao()" class="container-icon"> <img class="icon-logout" src="./Assets/logout 2.png">
        </div></a>
      </div>
    </div>

    <div class="content">
      <h1>Enviar Departamento para o Servidor</h1>
      <div class="caixa_texto" id="textAreaInsights"></div>
      <div class="caixa_button">
        <button id="sendDepIdButton">Gerar insights</button>
      </div>
  </div>

</body>

</html>

<script>
  document
    .getElementById("sendDepIdButton")
    .addEventListener("click", async function () {
      const userPermission = sessionStorage.getItem("PERMISSAO_USUARIO");
      let userInsightKey;
      let bodyServerName;
      let whereParam;
      let joinParam;

      if (userPermission == "Governador") {
        userInsightKey = sessionStorage.getItem("ESTADO_USUARIO");
        bodyServerName = "userStateNameServer";
        whereParam = "fk_cidade_estado";
        joinParam = "JOIN cidade_estado c ON i.fk_cidade_estado = c.cidade_estado_id";
        await sendValueForJava(userInsightKey, stringFetch, bodyServerName);
        await getInsights(userInsightKey, whereParam, joinParam);
      } else {
        userInsightKey = sessionStorage.getItem("DEPARTAMENTO_USUARIO");
        bodyServerName = "depUserServer";
        whereParam = "fk_departamento";
        joinParam = "JOIN departamento d on i.fk_departamento = d.departamento_id";
        await sendValueForJava(userInsightKey, bodyServerName);
      }
    });

  async function sendValueForJava(userInsightKey, bodyServerName) {
    let obj = {};
    obj[bodyServerName] = userInsightKey;

    if (userInsightKey && obj) {
      await fetch("/insight/executeJar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(obj)
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            console.log("Arquivo .jar executado com sucesso.");
          } else {
            console.log("Erro ao executar .jar: ", data.message);
          }
        })
        .catch((error) => {
          console.error("Erro na requisição:", error);
        });
    } else {
      console.log(
        "Valor não encontrado no sessionStorage."
      );
    }
  }

  async function getInsight(userInsightKey, whereParam, joinParam) {
    if (userInsightKey && whereParam && joinParam) {
      await fetch("/insight/getInsight", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          userInsightKeyServer: userInsightKey,
          whereParamServer: whereParam,
          joinParamServer: joinParam
        }),
      })
        .then(res => {
          if (res.ok) {
            res.json().then(json => {
              document.getElementById("textAreaInsights").innerHTML = `${json.texto_insight}`
            });
          } else {
            res.text().then(texto => {
              throw "a" + texto;
            });
          }
        })
        .catch((error) => {
          console.error("Erro na requisição:", error);
        });
    } else {
      console.log(
        "Valor não encontrado no sessionStorage."
      );
    }

  }

</script>